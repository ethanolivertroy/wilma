name: Test Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Minimal permissions for security
permissions:
  contents: read

jobs:
  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]

    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run ruff linter
      run: |
        echo "üîç Running ruff linter..."
        ruff check src/ tests/ --output-format=github
      continue-on-error: false

    - name: Run bandit security scanner
      run: |
        echo "üîí Running bandit security scanner..."
        bandit -r src/ -f json -o bandit-report.json -s B101,B106,B107,B112,B601 || true
        bandit -r src/ -f screen -s B101,B106,B107,B112,B601
      continue-on-error: false

    - name: Run mypy type checker
      run: |
        echo "üîé Running mypy type checker..."
        mypy src/wilma --show-error-codes --pretty
      continue-on-error: true  # Intentional: type hints are incremental, don't block CI

    - name: Run unit and integration tests with coverage
      run: |
        echo "üß™ Running unit and integration tests with coverage..."
        pytest \
          --cov=wilma \
          --cov-report=term-missing \
          --cov-report=xml \
          --cov-report=html \
          --cov-fail-under=50  # Matches PR template requirements \
          -v \
          -m "not slow"
      env:
        AWS_DEFAULT_REGION: us-east-1

    - name: Run contract tests
      run: |
        echo "üìã Running contract tests..."
        pytest -v -m contract
      env:
        AWS_DEFAULT_REGION: us-east-1

    - name: Upload coverage reports
      if: matrix.python-version == '3.11'
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: coverage-reports
        path: |
          coverage.xml
          htmlcov/
          bandit-report.json

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
    - name: Check test results
      run: |
        if [ "${{ needs.test.result }}" == "failure" ]; then
          echo "‚ùå Tests failed! Please fix the issues before merging."
          exit 1
        elif [ "${{ needs.test.result }}" == "success" ]; then
          echo "‚úÖ All tests passed successfully!"
        else
          echo "‚ö†Ô∏è Tests completed with status: ${{ needs.test.result }}"
        fi
