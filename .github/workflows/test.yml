name: Test Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Minimal permissions for security
permissions:
  contents: read

jobs:
  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]

    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run ruff linter
      run: |
        echo "üîç Running ruff linter..."
        ruff check src/ tests/ --output-format=github
      continue-on-error: false

    - name: Run bandit security scanner
      run: |
        echo "üîí Running bandit security scanner..."
        bandit -r src/ -f json -o bandit-report.json -s B101,B106,B107,B112,B601 || true
        bandit -r src/ -f screen -s B101,B106,B107,B112,B601
      continue-on-error: false

    - name: Run mypy type checker
      run: |
        echo "üîé Running mypy type checker..."
        mypy src/wilma --show-error-codes --pretty
      continue-on-error: true  # Intentional: type hints are incremental, don't block CI

    - name: Run unit and integration tests with coverage
      run: |
        echo "üß™ Running unit and integration tests with coverage..."
        pytest \
          --cov=wilma \
          --cov-report=term-missing \
          --cov-report=xml \
          --cov-report=html \
          --cov-fail-under=50  # Matches PR template requirements \
          -v \
          -m "not slow"
      env:
        AWS_DEFAULT_REGION: us-east-1

    - name: Run contract tests
      run: |
        echo "üìã Running contract tests..."
        pytest -v -m contract
      env:
        AWS_DEFAULT_REGION: us-east-1

    - name: Upload coverage reports
      if: matrix.python-version == '3.11'
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: coverage-reports
        path: |
          coverage.xml
          htmlcov/
          bandit-report.json

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
    - name: Check test results
      run: |
        if [ "${{ needs.test.result }}" == "failure" ]; then
          echo "‚ùå Tests failed! Please fix the issues before merging."
          exit 1
        elif [ "${{ needs.test.result }}" == "success" ]; then
          echo "‚úÖ All tests passed successfully!"
        else
          echo "‚ö†Ô∏è Tests completed with status: ${{ needs.test.result }}"
        fi
