name: Test Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run ruff linter
      run: |
        echo "ğŸ” Running ruff linter..."
        ruff check src/ tests/ --output-format=github
      continue-on-error: false

    - name: Run bandit security scanner
      run: |
        echo "ğŸ”’ Running bandit security scanner..."
        bandit -r src/ -f json -o bandit-report.json -s B101,B106,B107,B112,B601 || true
        bandit -r src/ -f screen -s B101,B106,B107,B112,B601
      continue-on-error: false

    - name: Run mypy type checker
      run: |
        echo "ğŸ” Running mypy type checker..."
        mypy src/wilma --show-error-codes --pretty
      continue-on-error: true  # Intentional: type hints are incremental, don't block CI

    - name: Run unit and integration tests with coverage
      run: |
        echo "ğŸ§ª Running unit and integration tests with coverage..."
        pytest \
          --cov=wilma \
          --cov-report=term-missing \
          --cov-report=xml \
          --cov-report=html \
          --cov-fail-under=50  # Matches PR template requirements \
          -v \
          -m "not slow"
      env:
        AWS_DEFAULT_REGION: us-east-1

    - name: Run contract tests
      run: |
        echo "ğŸ“‹ Running contract tests..."
        pytest -v -m contract
      env:
        AWS_DEFAULT_REGION: us-east-1

    - name: Upload coverage reports
      if: matrix.python-version == '3.11'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: |
          coverage.xml
          htmlcov/
          bandit-report.json

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
    - name: Check test results
      run: |
        if [ "${{ needs.test.result }}" == "failure" ]; then
          echo "âŒ Tests failed! Please fix the issues before merging."
          exit 1
        elif [ "${{ needs.test.result }}" == "success" ]; then
          echo "âœ… All tests passed successfully!"
        else
          echo "âš ï¸ Tests completed with status: ${{ needs.test.result }}"
        fi
