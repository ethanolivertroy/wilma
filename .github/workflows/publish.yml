name: Publish to PyPI

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'pyproject.toml'
      - 'setup.py'

# Minimal default permissions
permissions:
  contents: read

jobs:
  test:
    name: Run Full Test Suite
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]

    steps:
    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run ruff linter
      run: ruff check src/ tests/

    - name: Run bandit security scanner
      run: bandit -r src/ -f screen -s B101,B106,B107,B112,B601

    - name: Run mypy type checker
      run: mypy src/wilma --show-error-codes
      continue-on-error: true  # Intentional: type hints are incremental, don't block CI

    - name: Run pytest with coverage
      run: |
        pytest \
          --cov=wilma \
          --cov-report=term-missing \
          --cov-fail-under=50  # Matches PR template requirements \
          -v \
          -m "not slow"
      env:
        AWS_DEFAULT_REGION: us-east-1

  check-version:
    name: Check Version Changed
    runs-on: ubuntu-latest
    needs: test
    outputs:
      should_publish: ${{ steps.version_check.outputs.should_publish }}
      version: ${{ steps.get_version.outputs.version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
      with:
        python-version: '3.11'

    - name: Get current version from pyproject.toml
      id: get_version
      run: |
        # tomllib is built-in for Python 3.11+; tomli used for 3.8-3.10 (installed via dev deps)
        VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])" 2>/dev/null || python -c "import tomli; print(tomli.load(open('pyproject.toml', 'rb'))['project']['version'])")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Current version: $VERSION"

    - name: Check if version exists on PyPI
      id: version_check
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        echo "Checking if wilma-sec==$VERSION exists on PyPI..."

        if pip index versions wilma-sec | grep -q "$VERSION"; then
          echo "âš ï¸ Version $VERSION already exists on PyPI"
          echo "should_publish=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… Version $VERSION is new - will publish"
          echo "should_publish=true" >> $GITHUB_OUTPUT
        fi

  publish:
    name: Build and Publish to PyPI
    runs-on: ubuntu-latest
    needs: check-version
    if: needs.check-version.outputs.should_publish == 'true'

    # Elevated permissions needed for this job
    permissions:
      contents: write      # Create tags and releases
      id-token: write      # PyPI trusted publishing

    environment:
      name: pypi
      url: https://pypi.org/project/wilma-sec/${{ needs.check-version.outputs.version }}/

    steps:
    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Set up Python
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
      with:
        python-version: '3.11'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: |
        echo "ğŸ”¨ Building package..."
        python -m build
        echo "ğŸ“¦ Package built successfully!"

    - name: Check package with twine
      run: |
        echo "ğŸ” Validating package..."
        twine check dist/*

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "ğŸš€ Publishing to PyPI..."
        twine upload dist/*
        echo "âœ… Successfully published wilma-sec==${{ needs.check-version.outputs.version }} to PyPI!"

    - name: Create Git tag
      run: |
        VERSION="${{ needs.check-version.outputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "v$VERSION" -m "Release version $VERSION"
        git push origin "v$VERSION"
        echo "ğŸ·ï¸ Created and pushed tag v$VERSION"

    - name: Create GitHub Release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        VERSION="${{ needs.check-version.outputs.version }}"

        # Extract release notes from CHANGELOG.md for this version
        awk '/## \['"$VERSION"'\]/,/^## \[/ {
          if (/## \['"$VERSION"'\]/) { found=1; next }
          if (/^## \[/ && found) exit
          if (found) print
        }' CHANGELOG.md > release_notes.md

        # Create GitHub release
        gh release create "v$VERSION" \
          --title "Wilma v$VERSION" \
          --notes-file release_notes.md \
          --verify-tag

        echo "ğŸ‰ GitHub Release created!"
        echo "ğŸ“¦ PyPI: https://pypi.org/project/wilma-sec/$VERSION/"
        echo "ğŸ·ï¸ Release: https://github.com/${{ github.repository }}/releases/tag/v$VERSION"

  publish-summary:
    name: Publish Summary
    runs-on: ubuntu-latest
    needs: [check-version, publish]
    if: always()

    steps:
    - name: Report status
      run: |
        if [ "${{ needs.check-version.outputs.should_publish }}" == "false" ]; then
          echo "â„¹ï¸ No publish needed - version ${{ needs.check-version.outputs.version }} already exists on PyPI"
        elif [ "${{ needs.publish.result }}" == "success" ]; then
          echo "ğŸ‰ Successfully published wilma-sec v${{ needs.check-version.outputs.version }} to PyPI!"
          echo "ğŸ“¦ View at: https://pypi.org/project/wilma-sec/${{ needs.check-version.outputs.version }}/"
        elif [ "${{ needs.publish.result }}" == "failure" ]; then
          echo "âŒ Publishing failed! Check the logs above."
          exit 1
        elif [ "${{ needs.publish.result }}" == "skipped" ]; then
          echo "â­ï¸ Publishing was skipped"
        fi
